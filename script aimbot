local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- --- C·∫§U H√åNH ---
local Settings = {
    Aimbot = false, BoxESP = false, LineESP = false,
    HP_ESP = false, FOVEnabled = false, FOVValue = 150,
    SpeedEnabled = false, SpeedValue = 16, MenuVisible = true
}

-- --- GIAO DI·ªÜN ---
local sgui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
sgui.Name = "BuMenuV16"
sgui.IgnoreGuiInset = true

-- Ch·ªØ PLAYERS ƒë·ªè (C√¢n ƒë·ªëi)
local playerCounter = Instance.new("TextLabel", sgui)
playerCounter.Size = UDim2.new(0, 300, 0, 50)
playerCounter.Position = UDim2.new(0.5, -150, 0.1, 0)
playerCounter.BackgroundTransparency = 1
playerCounter.TextColor3 = Color3.fromRGB(255, 0, 0)
playerCounter.Font = Enum.Font.GothamBold
playerCounter.TextSize = 35
playerCounter.Text = "PLAYERS: 0"

-- Icon üí¢
local icon = Instance.new("TextButton", sgui)
icon.Size = UDim2.new(0, 45, 0, 45)
icon.Position = UDim2.new(0, 10, 0.5, -22)
icon.Text = "üí¢"
icon.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Instance.new("UICorner", icon).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", icon).Color = Color3.new(1, 0, 0)

-- Menu Buüí¢
local main = Instance.new("Frame", sgui)
main.Size = UDim2.new(0, 260, 0, 400)
main.Position = UDim2.new(0.5, -130, 0.5, -200)
main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
main.Visible = Settings.MenuVisible
main.Active = true
main.Draggable = true
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1, 0, 0, 45)
title.Text = "Buüí¢"
title.TextColor3 = Color3.new(0, 1, 0)
title.Font = Enum.Font.GothamBold
title.TextSize = 24
title.BackgroundTransparency = 1

icon.MouseButton1Click:Connect(function()
    Settings.MenuVisible = not Settings.MenuVisible
    main.Visible = Settings.MenuVisible
end)

local container = Instance.new("ScrollingFrame", main)
container.Size = UDim2.new(1, -10, 1, -60)
container.Position = UDim2.new(0, 5, 0, 50)
container.BackgroundTransparency = 1
container.CanvasSize = UDim2.new(0, 0, 2.5, 0)
container.ScrollBarThickness = 2
Instance.new("UIListLayout", container).Padding = UDim.new(0, 8)

-- --- SLIDER & TOGGLE ---
local function createSlider(text, min, max, varName)
    local frame = Instance.new("Frame", container)
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundTransparency = 1
    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(1, 0, 0, 15)
    label.Text = text .. ": " .. Settings[varName]
    label.TextColor3 = Color3.new(1, 1, 1)
    label.BackgroundTransparency = 1
    local sliderBG = Instance.new("Frame", frame)
    sliderBG.Size = UDim2.new(0.8, 0, 0, 4)
    sliderBG.Position = UDim2.new(0.1, 0, 0.7, 0)
    sliderBG.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
    local knob = Instance.new("TextButton", sliderBG)
    knob.Size = UDim2.new(0, 18, 0, 18)
    knob.AnchorPoint = Vector2.new(0.5, 0.5)
    knob.Position = UDim2.new((Settings[varName] - min) / (max - min), 0, 0.5, 0)
    knob.Text = ""
    Instance.new("UICorner", knob).CornerRadius = UDim.new(1, 0)
    local dragging = false
    knob.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dragging = true end end)
    UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dragging = false end end)
    RunService.RenderStepped:Connect(function()
        if dragging then
            local rel = math.clamp((UserInputService:GetMouseLocation().X - sliderBG.AbsolutePosition.X) / sliderBG.AbsoluteSize.X, 0, 1)
            knob.Position = UDim2.new(rel, 0, 0.5, 0)
            Settings[varName] = math.floor(min + (max - min) * rel)
            label.Text = text .. ": " .. Settings[varName]
        end
    end)
end

-- --- H√ÄM V·∫º ESP (D√ôNG DRAWING LIB CHO LINE) ---
local function createESP(p)
    if p == LocalPlayer then return end
    
    local line = Drawing.new("Line") -- V·∫Ω 2D Overlay (Kh·∫Øc ph·ª•c l·ªói xoay)
    line.Visible = false
    line.From = Vector2.new(Camera.ViewportSize.X / 2, 0)
    line.Color = Color3.new(1, 1, 0)
    line.Thickness = 2

    local folder = Instance.new("Folder", sgui)
    local box = Instance.new("Frame", folder)
    box.BackgroundTransparency = 1
    Instance.new("UIStroke", box).Color = Color3.new(1, 1, 1)

    local hp = Instance.new("Frame", folder)
    hp.BackgroundColor3 = Color3.new(0, 0, 0)
    local hpF = Instance.new("Frame", hp)
    hpF.BorderSizePixel = 0

    RunService.RenderStepped:Connect(function()
        if p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") then
            local hrp = p.Character.HumanoidRootPart
            local hum = p.Character.Humanoid
            local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)

            if onScreen then
                local top = Camera:WorldToViewportPoint(hrp.Position + Vector3.new(0, 3.8, 0))
                local bottom = Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 3.8, 0))
                local h = math.abs(top.Y - bottom.Y)
                local w = h * 0.6

                box.Visible = Settings.BoxESP
                box.Size = UDim2.new(0, w, 0, h)
                box.Position = UDim2.new(0, pos.X - w/2, 0, pos.Y - h/2)

                -- S·ª≠a tri·ªát ƒë·ªÉ Line ESP: Kh√¥ng d√πng Frame xoay n·ªØa
                if Settings.LineESP then
                    line.Visible = true
                    line.From = Vector2.new(Camera.ViewportSize.X / 2, 0)
                    line.To = Vector2.new(pos.X, pos.Y - h/2)
                else line.Visible = false end

                -- HP ESP
                hp.Visible = Settings.HP_ESP
                hp.Size = UDim2.new(0, 4, 0, h)
                hp.Position = UDim2.new(0, pos.X - w/2 - 7, 0, pos.Y - h/2)
                local hpPct = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
                hpF.Size = UDim2.new(1, 0, hpPct, 0)
                hpF.Position = UDim2.new(0, 0, 1 - hpPct, 0)
                hpF.BackgroundColor3 = Color3.new(1-hpPct, hpPct, 0)
            else
                box.Visible = false; line.Visible = false; hp.Visible = false
            end
        else
            box.Visible = false; line.Visible = false; hp.Visible = false
        end
    end)
end

-- --- N√öT B·∫§T T·∫ÆT ---
local function createToggle(t, v)
    local b = Instance.new("TextButton", container)
    b.Size = UDim2.new(1, 0, 0, 35)
    b.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    b.Text = t .. " ‚ùå"
    b.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(function()
        Settings[v] = not Settings[v]
        b.Text = t .. (Settings[v] and " ‚úÖ" or " ‚ùå")
        b.BackgroundColor3 = Settings[v] and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(40, 40, 40)
    end)
end

createToggle("AIMBOT", "Aimbot")
createToggle("BOX ESP", "BoxESP")
createToggle("LINE ESP", "LineESP")
createToggle("HP ESP", "HP_ESP")
createToggle("FOV CIRCLE", "FOVEnabled")
createSlider("FOV VALUE", 30, 800, "FOVValue")
createToggle("SPEED HACK", "SpeedEnabled")
createSlider("SPEED VALUE", 16, 500, "SpeedValue")

-- FOV C·∫ßu V·ªìng
local fovC = Instance.new("Frame", sgui)
fovC.BackgroundTransparency = 1
local fStroke = Instance.new("UIStroke", fovC)
fStroke.Thickness = 2
Instance.new("UICorner", fovC).CornerRadius = UDim.new(1, 0)

RunService.RenderStepped:Connect(function()
    playerCounter.Text = "PLAYERS: " .. #Players:GetPlayers()
    
    if Settings.FOVEnabled then
        fovC.Visible = true
        fovC.Size = UDim2.new(0, Settings.FOVValue * 2, 0, Settings.FOVValue * 2)
        fovC.Position = UDim2.new(0.5, -Settings.FOVValue, 0.5, -Settings.FOVValue)
        fStroke.Color = Color3.fromHSV(tick() % 5 / 5, 1, 1)
    else fovC.Visible = false end

    -- Speed Hack Fix
    if Settings.SpeedEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = Settings.SpeedValue
    end

    if Settings.Aimbot then
        local target = nil
        local dist = math.huge
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Head") then
                local pos, onScreen = Camera:WorldToViewportPoint(p.Character.Head.Position)
                if onScreen then
                    local mDist = (Vector2.new(pos.X, pos.Y) - (Camera.ViewportSize / 2)).Magnitude
                    if mDist < dist and (not Settings.FOVEnabled or mDist < Settings.FOVValue) then
                        dist = mDist
                        target = p.Character.Head
                    end
                end
            end
        end
        if target then Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Position) end
    end
end)

Players.PlayerAdded:Connect(createESP)
for _, p in pairs(Players:GetPlayers()) do createESP(p) end